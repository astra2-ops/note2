<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Capture, Edit and Save to PDF</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f9;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    h1 {
      color: #333;
    }
    #camera {
      display: block;
      margin: 20px 0;
      border: 2px solid #ccc;
      border-radius: 8px;
    }
    .canvas-container {
      position: relative;
      display: inline-block;
      margin: 20px;
    }
    .canvas-container canvas {
      display: block;
      max-width: 320px;
      max-height: 240px;
      border: 2px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    #capture, #next, #save, #clear-annotations, #switch-camera {
      margin: 10px;
      padding: 12px 20px;
      font-size: 16px;
      border-radius: 5px;
      border: none;
      cursor: pointer;
      background-color: #5C6BC0;
      color: white;
    }
    #capture:disabled, #next:disabled {
      background-color: #b0b0b0;
      cursor: not-allowed;
    }
    #next {
      display: none;
    }
    #save {
      margin-top: 20px;
      background-color: #4CAF50;
    }
    .thumbnails-grid {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 20px;
    }
    .thumbnail {
      position: relative;
      margin: 5px;
      display: inline-block;
    }
    .thumbnail img {
      width: 60px;
      height: 45px;
      border-radius: 5px;
      border: 1px solid #ddd;
    }
    .delete-btn {
      position: absolute;
      top: 0;
      right: 0;
      background-color: red;
      color: white;
      border: none;
      padding: 5px;
      cursor: pointer;
      font-size: 12px;
      border-radius: 50%;
    }
    .controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 20px 0;
    }
    .controls label {
      margin-right: 10px;
    }
  </style>
</head>
<body>

  <h1>Capture, Draw, and Save Photos to PDF</h1>

  <!-- Camera and control buttons -->
  <video id="camera" width="320" height="240" autoplay></video>
  <button id="capture">Capture Photo</button>
  <button id="switch-camera">Switch Camera</button>

  <!-- Controls for pen size, color, and delete annotations -->
  <div class="controls">
    <label for="pen-size">Pen Size: </label>
    <input type="range" id="pen-size" min="1" max="10" value="5">
    <label for="pen-color">Pen Color: </label>
    <input type="color" id="pen-color" value="#000000">
    <button id="clear-annotations">Clear Annotations</button>
  </div>

  <!-- Next and Save buttons -->
  <button id="next" style="display: none;">Next</button>
  <button id="save">Save All to PDF</button>

  <!-- Thumbnails grid -->
  <div class="thumbnails-grid" id="thumbnails"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const camera = document.getElementById('camera');
    const captureButton = document.getElementById('capture');
    const nextButton = document.getElementById('next');
    const saveButton = document.getElementById('save');
    const clearAnnotationsButton = document.getElementById('clear-annotations');
    const switchCameraButton = document.getElementById('switch-camera');
    const thumbnailsGrid = document.getElementById('thumbnails');
    const penSizeInput = document.getElementById('pen-size');
    const penColorInput = document.getElementById('pen-color');
    const { jsPDF } = window.jspdf; // Import jsPDF
    let images = [];
    let pdfDoc = null;
    let currentCanvas = null;
    let currentCtx = null;
    let penSize = 5;
    let penColor = '#000000';
    let drawing = false;
    let lastX = 0, lastY = 0;
    let currentStream = null;
    let currentDeviceId = null;

    // Function to initialize camera stream
    function initializeCamera(deviceId) {
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop()); // Stop previous stream
      }

      const constraints = {
        video: {
          deviceId: deviceId ? { exact: deviceId } : undefined,
          facingMode: (deviceId && deviceId === currentDeviceId) ? 'user' : 'environment',
        }
      };

      navigator.mediaDevices.getUserMedia(constraints)
        .then(stream => {
          camera.srcObject = stream;
          currentStream = stream;
          currentDeviceId = deviceId;
        })
        .catch(err => console.error('Camera Error: ', err));
    }

    // Access all available video devices
    let videoDevices = [];

    navigator.mediaDevices.enumerateDevices()
      .then(devices => {
        videoDevices = devices.filter(device => device.kind === 'videoinput');
        if (videoDevices.length > 0) {
          initializeCamera(videoDevices[1].deviceId); // Start with back camera by default
        }
      })
      .catch(err => console.error('Error listing devices: ', err));

    // Switch between front and back cameras
    switchCameraButton.addEventListener('click', () => {
      const nextDeviceId = videoDevices.find(device => device.deviceId !== currentDeviceId);
      if (nextDeviceId) {
        initializeCamera(nextDeviceId.deviceId);
      }
    });

    // Capture the photo
    captureButton.addEventListener('click', () => {
      const videoWidth = camera.videoWidth;
      const videoHeight = camera.videoHeight;
      const newCanvas = document.createElement('canvas');
      const newCtx = newCanvas.getContext('2d');

      newCanvas.width = videoWidth;
      newCanvas.height = videoHeight;
      newCtx.drawImage(camera, 0, 0, videoWidth, videoHeight);

      // Create canvas container for editing
      const canvasContainer = document.createElement('div');
      canvasContainer.classList.add('canvas-container');
      canvasContainer.appendChild(newCanvas);
      document.body.appendChild(canvasContainer); // Preview the canvas

      currentCanvas = newCanvas;
      currentCtx = newCtx;

      // Enable drawing on the canvas
      newCanvas.addEventListener('mousedown', (e) => {
        drawing = true;
        const rect = currentCanvas.getBoundingClientRect();
        lastX = e.clientX - rect.left;
        lastY = e.clientY - rect.top;
      });

      newCanvas.addEventListener('mousemove', (e) => {
        if (!drawing) return;
        const rect = currentCanvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        currentCtx.strokeStyle = penColor;
        currentCtx.lineWidth = penSize;
        currentCtx.beginPath();
        currentCtx.moveTo(lastX, lastY);
        currentCtx.lineTo(x, y);
        currentCtx.stroke();

        lastX = x;
        lastY = y;
      });

      newCanvas.addEventListener('mouseup', () => drawing = false);
      newCanvas.addEventListener('mouseout', () => drawing = false);

      // Disable the capture button to prevent further captures until next is clicked
      captureButton.disabled = true;

      // Show the next button
      nextButton.style.display = 'block';
    });

    // Move to next image and add it to grid
    nextButton.addEventListener('click', () => {
      // Create a thumbnail of the current image
      const thumbnailCanvas = document.createElement('canvas');
      const thumbnailCtx = thumbnailCanvas.getContext('2d');
      thumbnailCanvas.width = 60;
      thumbnailCanvas.height = 45;
      thumbnailCtx.drawImage(currentCanvas, 0, 0, 60, 45);

      const thumbnailDiv = document.createElement('div');
      thumbnailDiv.classList.add('thumbnail');
      thumbnailDiv.appendChild(thumbnailCanvas);

      // Add a delete button to the thumbnail
      const deleteBtn = document.createElement('button');
      deleteBtn.classList.add('delete-btn');
      deleteBtn.textContent = 'X';
      thumbnailDiv.appendChild(deleteBtn);
      deleteBtn.addEventListener('click', () => {
        thumbnailDiv.remove();
        images = images.filter(img => img !== currentCanvas);
      });

      thumbnailsGrid.appendChild(thumbnailDiv);
      images.push(currentCanvas); // Save the image for the PDF

      // Reset the canvas for the next photo
      currentCanvas = null;
      currentCtx = null;

      // Enable the capture button again and hide the next button
      captureButton.disabled = false;
      nextButton.style.display = 'none';
    });

    // Save images as PDF
    saveButton.addEventListener('click', () => {
      if (images.length === 0) {
        alert('No images to save.');
        return;
      }

      pdfDoc = new jsPDF();
      images.forEach((canvas, index) => {
        if (index > 0) pdfDoc.addPage();
        const imgData = canvas.toDataURL('image/png');
        pdfDoc.addImage(imgData, 'PNG', 10, 10, 180, 140);
      });

      pdfDoc.save('photos.pdf');
    });

    // Clear annotations on the current image
    clearAnnotationsButton.addEventListener('click', () => {
      if (currentCtx) {
        currentCtx.clearRect(0, 0, currentCanvas.width, currentCanvas.height);
      }
    });
  </script>
</body>
</html>
